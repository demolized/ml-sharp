// Video Gallery JavaScript - TwentyTwenty Comparison
// Auto-generated by generate_video_gallery.py

const videoData = {
  "Unsplash": {
    "-5wkyNA2BPc_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "-B_lu05yfgE_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "-6ebJNtXtWs_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "-591oIJnyEQ_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "-Ejwm8Z0cAU_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "ETH3D": {
    "courtyard_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "facade_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "pipes_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "relief_00000_0000-0003": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "terrains_00002_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "Middlebury": {
    "49b2bcfdd9_000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "ea068642ad_000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "4e99cbe338_000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "b1f97f9954_000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "9093b3b791_000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "ScanNetPP": {
    "d755b3d9d8_00004_0000-0006": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "fb5a96b1a2_00110_0000-0004": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "e7af285f7d_00075_0000-0009": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "f9f95681fd_00008_0000-0004": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "09c1414f1b_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "TanksAndTemples": {
    "Church_00022_0000-0002": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "Church_00040_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "Meetingroom_00004_0000-0002": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "Meetingroom_00023_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "Truck_00007_0000-0002": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "Booster": {
    "train+balanced+Motorcycle+camera_00+im6.png_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "train+balanced+Bathroom+camera_00+im0.png_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "train+balanced+Toilet+camera_00+im4.png_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "train+balanced+Moka1+camera_00+im1.png_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "train+balanced+CoffeeMaker+camera_00+im0.png_00000_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  },
  "WildRGBD": {
    "TV+scene_000_00028_0000-0002": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "truck+scene_064_00031_0000-0007": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "remote_control+scene_127_00031_0000-0005": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "bottle+scene_198_00020_0000-0001": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ],
    "banana+scene_003_00021_0000-0005": [
      "sharp_aligned",
      "flash3d_aligned",
      "gen3c_aligned",
      "view_crafter_aligned",
      "tmpi_aligned",
      "lvsm_sweep",
      "stable_virtual_camera_sweep"
    ]
  }
};


const METHOD_NAMES = {
    'flash3d_aligned': 'Flash3D',
    'gen3c_aligned': 'Gen3C',
    'sharp_aligned': 'SHARP',
    'lvsm_sweep': 'LVSM',
    'stable_virtual_camera_sweep': 'SVC',
    'tmpi_aligned': 'TMPI',
    'view_crafter_aligned': 'ViewCrafter'
};

let currentDataset = null;
let currentVideo = null;
let currentMethod = 'gen3c_aligned'; // Default to Gen3C

// Switch dataset tab
function switchDataset(datasetId) {
    // Update tab active state using Bootstrap nav-link class
    document.querySelectorAll('.dataset-nav .nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.dataset-nav .nav-link[data-dataset="${datasetId}"]`).classList.add('active');

    // Update content area visibility
    document.querySelectorAll('.dataset-content-area').forEach(area => {
        area.classList.remove('active');
    });
    document.getElementById('content-' + datasetId).classList.add('active');

    // Reset state
    currentDataset = datasetId;
    currentMethod = 'gen3c_aligned';

    // Set first method button as active
    document.querySelectorAll(`#methods-${datasetId} .btn`).forEach(b => {
        b.classList.remove('active');
    });
    const firstButton = document.querySelector(`#methods-${datasetId} .btn[data-method="gen3c_aligned"]`);
    if (firstButton) {
        firstButton.classList.add('active');
    }

    // Auto-select first video
    const firstThumbnail = document.querySelector(`#thumbnails-${datasetId} .thumbnail-item`);
    if (firstThumbnail) {
        const videoName = firstThumbnail.getAttribute('data-video-name');

        // Update thumbnail active state
        document.querySelectorAll(`#thumbnails-${datasetId} .thumbnail-item`).forEach(t => {
            t.classList.remove('active');
        });
        firstThumbnail.classList.add('active');

        currentVideo = videoName;
        loadComparison(datasetId, videoName, currentMethod);
    }
}

// Select a method (from button)
function selectMethod(dataset, method, buttonElement) {
    // Update button active state in the button group
    document.querySelectorAll(`#methods-${dataset} .btn`).forEach(b => {
        b.classList.remove('active');
    });
    buttonElement.classList.add('active');

    currentMethod = method;

    // Reload comparison if video is selected
    if (currentVideo) {
        loadComparison(dataset, currentVideo, method);
    }
}

// Select a video (from thumbnail)
function selectVideo(dataset, videoName, thumbnailElement) {
    // Update thumbnail active state
    document.querySelectorAll(`#thumbnails-${dataset} .thumbnail-item`).forEach(t => {
        t.classList.remove('active');
    });
    thumbnailElement.classList.add('active');

    currentVideo = videoName;

    // Load comparison with current method
    loadComparison(dataset, videoName, currentMethod);
}

// Load TwentyTwenty comparison
function loadComparison(dataset, videoName, compareMethod) {
    const comparisonArea = document.getElementById('comparison-' + dataset);
    if (!comparisonArea) return;

    // Check if SHARP exists for this video
    const methods = videoData[dataset][videoName];
    if (!methods || !methods.includes('sharp_aligned')) {
        comparisonArea.innerHTML = '<div class="loading-message">SHARP not available for this video</div>';
        return;
    }

    // Check if comparison method exists
    if (!methods.includes(compareMethod)) {
        comparisonArea.innerHTML = `<div class="loading-message">${METHOD_NAMES[compareMethod] || compareMethod} not available for this video</div>`;
        return;
    }

    // Build video paths - all in unified structure under dataset folder
    let sharpPath, comparePath;

    // For all datasets (including Unsplash), use simplified paths
    // Use video_selections folder for whitelisted videos
    sharpPath = `video_selections/${dataset}/sharp_aligned/${videoName}.mp4`;
    comparePath = `video_selections/${dataset}/${compareMethod}/${videoName}.mp4`;

    // Create TwentyTwenty container with unique ID and controls
    const containerId = `tt-${dataset}-${Date.now()}`;
    comparisonArea.innerHTML = `
        <div id="comparison-container">
            <div id="${containerId}">
                <video class="video" loop muted playsinline preload="auto">
                    <source src="${sharpPath}" type="video/mp4">
                </video>
                <video class="video" loop muted playsinline preload="auto">
                    <source src="${comparePath}" type="video/mp4">
                </video>
            </div>
            <div class="video-controls d-flex justify-content-center gap-2 flex-wrap">
                <button class="btn btn-outline-primary" onclick="playVideos('${containerId}')">Play</button>
                <button class="btn btn-outline-primary" onclick="pauseVideos('${containerId}')">Pause</button>
                <button class="btn btn-outline-primary" onclick="resetVideos('${containerId}')">Reset</button>
            </div>
        </div>
    `;

    // Wait for DOM update, then check video metadata and initialize
    setTimeout(() => {
        const container = $(`#${containerId}`);
        const videos = container.find('video');
        const video1 = videos[0];
        const video2 = videos[1];

        // Wait for both videos to have metadata loaded
        let video1Ready = false;
        let video2Ready = false;

        function checkAndInitialize() {
            if (video1Ready && video2Ready) {
                initializeTwentyTwenty();
            }
        }

        function initializeTwentyTwenty() {
            const videoWidth = video1.videoWidth;
            const videoHeight = video1.videoHeight;

            if (videoWidth === 0 || videoHeight === 0) {
                console.error('Video has no dimensions');
                return;
            }

            const ratio = videoHeight / videoWidth;

            // Set container max-width based on aspect ratio to prevent overflow
            // For portrait videos (ratio > 1), constrain the width
            if (ratio > 1) {
                // Portrait: limit width to reasonable size
                const maxDisplayHeight = 800; // Max height we want to display
                const calculatedWidth = maxDisplayHeight / ratio;
                container.css('max-width', Math.min(calculatedWidth, 600) + 'px');
            } else {
                // Landscape: use full container width
                container.css('max-width', '100%');
            }

            // Initialize TwentyTwenty with calculated ratio
            container.twentytwenty({
                default_offset_pct: 0.5,
                orientation: 'horizontal',
                before_label: 'SHARP (Ours)',
                after_label: METHOD_NAMES[compareMethod] || compareMethod,
                no_overlay: false,
                move_slider_on_hover: false,
                move_with_handle_only: false,  // Allow dragging anywhere on container
                click_to_move: false,
                ratio: ratio
            });

            // Setup video synchronization
            setupVideoSync(containerId);

            // Auto-play videos after initialization
            setTimeout(() => {
                const videos = document.querySelectorAll(`#${containerId} video`);
                if (videos.length === 2) {
                    videos[0].play().catch(err => console.log('Autoplay prevented:', err));
                }
            }, 100);
        }

        // Check if metadata is already loaded for video 1
        if (video1.readyState >= 1) {
            video1Ready = true;
        } else {
            $(video1).on('loadedmetadata', function() {
                video1Ready = true;
                checkAndInitialize();
            });
        }

        // Check if metadata is already loaded for video 2
        if (video2.readyState >= 1) {
            video2Ready = true;
        } else {
            $(video2).on('loadedmetadata', function() {
                video2Ready = true;
                checkAndInitialize();
            });
        }

        // Initial check if both are ready
        checkAndInitialize();
    }, 100);
}

// Setup synchronized video playback
function setupVideoSync(containerId) {
    const videos = document.querySelectorAll(`#${containerId} video`);
    if (videos.length !== 2) return;

    const [video1, video2] = Array.from(videos);

    // Sync play/pause
    video1.addEventListener('play', () => video2.play());
    video1.addEventListener('pause', () => video2.pause());
    video2.addEventListener('play', () => video1.play());
    video2.addEventListener('pause', () => video1.pause());

    // Sync seeking
    let seeking1 = false, seeking2 = false;

    video1.addEventListener('seeking', () => {
        if (!seeking2) {
            seeking1 = true;
            video2.currentTime = video1.currentTime;
        }
    });

    video1.addEventListener('seeked', () => {
        seeking1 = false;
    });

    video2.addEventListener('seeking', () => {
        if (!seeking1) {
            seeking2 = true;
            video1.currentTime = video2.currentTime;
        }
    });

    video2.addEventListener('seeked', () => {
        seeking2 = false;
    });

    // Sync time updates (for consistent playback)
    let syncing = false;
    video1.addEventListener('timeupdate', () => {
        if (!syncing && Math.abs(video1.currentTime - video2.currentTime) > 0.1) {
            syncing = true;
            video2.currentTime = video1.currentTime;
            setTimeout(() => syncing = false, 100);
        }
    });
}

// Video control functions
function playVideos(containerId) {
    document.querySelectorAll(`#${containerId} video`).forEach(v => v.play());
}

function pauseVideos(containerId) {
    document.querySelectorAll(`#${containerId} video`).forEach(v => v.pause());
}

function resetVideos(containerId) {
    document.querySelectorAll(`#${containerId} video`).forEach(v => {
        v.pause();
        v.currentTime = 0;
    });
}

// Initialize first dataset on page load
$(document).ready(function() {
    // Get first dataset from Bootstrap nav-link
    const firstTab = document.querySelector('.dataset-nav .nav-link.active');
    if (firstTab) {
        const datasetId = firstTab.getAttribute('data-dataset');
        switchDataset(datasetId);
    }
});
